<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Notes</title>
    <script src="https://unpkg.com/cookielib/src/cookie.min.js"></script>
</head>
<body>
<label for="text">Введите ваше сообщение:</label><br>
<input id="text"/>
<input type="button" onclick="save()" value="Сохранить">
<input type="button" onclick="window.location.replace('/')" value="Назад">

<script>

    function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split("=");
            if (pair[0] === variable) {
                return pair[1];
            }
        }
        return ""
    }

    let note_id = getQueryVariable("id");
    if (note_id !== '') {
        let token = getCookie('bearer_token')
        fetch('/note/' + note_id, {
            headers: {'Authorization': 'Bearer ' + token}
        }).then((resp) => {
                if (resp.status === 401)
                    window.location.replace('/login.html')
                else if (resp.status === 200) {
                    resp.json().then((data) => {
                        document.getElementById('text').value = data['text']
                    })
                }
            }
        )
    }

    function save() {
        let token = getCookie('bearer_token')
        let method = 'PUT'
        if (note_id !== '')
            method = 'PATCH'
        fetch('/note/' + note_id, {
            method: method,
            headers: {
                'Authorization': 'Bearer ' + token,
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({text: document.getElementById('text').value})
        }).then((resp) => {
                if (resp.status === 401)
                    window.location.replace('/login.html')
                else if (resp.status === 200) {
                    window.location.replace('/')
                } else {
                    alert('Server error')
                }
            }
        )
    }
</script>
</body>
</html>